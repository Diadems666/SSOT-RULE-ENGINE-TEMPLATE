{% extends "layout.html" %}

{% block title %}{{ selected_date.strftime('%d %B %Y') }} - Takings{% endblock %}

{% block extra_css %}
<style>
    .float-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .section-title {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .table th, .table td {
        vertical-align: middle;
    }
    
    .totals-box {
        background-color: #e9ecef;
        border-radius: 5px;
        padding: 10px;
    }
    
    .variance-positive {
        color: green;
        font-weight: bold;
    }
    
    .variance-negative {
        color: red;
        font-weight: bold;
    }
    
    .nav-tabs .nav-link {
        font-weight: bold;
    }
    
    /* Money input field styles */
    input[type="number"] {
        text-align: right;
    }
    
    /* Green glow for focused inputs */
    input[type="number"]:focus {
        box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
        border-color: #28a745;
    }
    
    /* Field indicator */
    .field-focused {
        background-color: rgba(40, 167, 69, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Daily Takings: {{ selected_date.strftime('%A, %d %B %Y') }}</h2>
    <div>
        <a href="{{ url_for('takings.calendar_view') }}" class="btn btn-outline-secondary">
            <i class="fas fa-calendar"></i> Calendar View
        </a>
        {% if takings.settled %}
        <span class="badge bg-success">Settled</span>
        {% endif %}
    </div>
</div>

{% if takings.settled %}
<div class="alert alert-warning">
    <strong>Note:</strong> This day's takings have been settled and cannot be modified.
</div>
{% endif %}

<form method="post">
    <div class="row">
        <!-- Left Column - Safe Float & Till Float -->
        <div class="col-md-6">
            <!-- Safe Float Section -->
            <div class="float-section">
                <h3 class="section-title">Safe Float (Target: $1,500.00)</h3>
                
                <ul class="nav nav-tabs" id="safeFloatTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="safe-float-open-tab" data-bs-toggle="tab" data-bs-target="#safe-float-open" type="button" role="tab" aria-controls="safe-float-open" aria-selected="true">
                            Opening
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="safe-float-close-tab" data-bs-toggle="tab" data-bs-target="#safe-float-close" type="button" role="tab" aria-controls="safe-float-close" aria-selected="false">
                            Closing
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content pt-3" id="safeFloatTabContent">
                    <!-- Safe Float Opening Tab -->
                    <div class="tab-pane fade show active" id="safe-float-open" role="tabpanel" aria-labelledby="safe-float-open-tab">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Denomination</th>
                                    <th>Value ($)</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for denom in denominations %}
                                <tr>
                                    <td>{{ denom }}</td>
                                    <td>
                                        <input type="number" step="0.01" name="safe_float_open_{{ denom }}" class="form-control safe-float-open-value money-input" 
                                               data-denom="{{ denom }}" min="0" 
                                               value="{{ safe_float_open.get(denom, 0) }}" 
                                               {% if takings.settled %}disabled{% endif %}>
                                    </td>
                                    <td class="safe-float-open-count" data-denom="{{ denom }}">
                                        {{ denom_counts.safe_float_open.get(denom, 0) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="safefloatOpenTotal">{{ format_currency(safe_float_open_total) }}</th>
                                </tr>
                                <tr>
                                    <th colspan="2">Difference from Target ($1,500.00)</th>
                                    <th id="safeFloatOpenDifference">
                                        {% if safe_float_open_total is not none %}
                                            {{ format_currency(safe_float_open_total - 1500) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Safe Float Closing Tab -->
                    <div class="tab-pane fade" id="safe-float-close" role="tabpanel" aria-labelledby="safe-float-close-tab">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Denomination</th>
                                    <th>Value ($)</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for denom in denominations %}
                                <tr>
                                    <td>{{ denom }}</td>
                                    <td>
                                        <input type="number" step="0.01" name="safe_float_close_{{ denom }}" class="form-control safe-float-close-value money-input" 
                                               data-denom="{{ denom }}" min="0" 
                                               value="{{ safe_float_close.get(denom, 0) }}" 
                                               {% if takings.settled %}disabled{% endif %}>
                                    </td>
                                    <td class="safe-float-close-count" data-denom="{{ denom }}">
                                        {{ denom_counts.safe_float_close.get(denom, 0) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="safefloatCloseTotal">{{ format_currency(safe_float_close_total) }}</th>
                                </tr>
                                <tr>
                                    <th colspan="2">Difference from Target ($1,500.00)</th>
                                    <th id="safeFloatCloseDifference">
                                        {% if safe_float_close_total is not none %}
                                            {{ format_currency(safe_float_close_total - 1500) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Till Float Section -->
            <div class="float-section">
                <h3 class="section-title">Till Float (Target: $500.00)</h3>
                
                <div class="mb-3">
                    <button type="button" id="countTillButton" class="btn btn-primary" {% if takings.settled %}disabled{% endif %}>
                        <i class="fas fa-calculator"></i> Count Till
                    </button>
                </div>
                
                <ul class="nav nav-tabs" id="tillFloatTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="till-float-open-tab" data-bs-toggle="tab" data-bs-target="#till-float-open" type="button" role="tab" aria-controls="till-float-open" aria-selected="true">
                            Opening
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="till-float-close-tab" data-bs-toggle="tab" data-bs-target="#till-float-close" type="button" role="tab" aria-controls="till-float-close" aria-selected="false">
                            Closing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="till-float-makeup-tab" data-bs-toggle="tab" data-bs-target="#till-float-makeup" type="button" role="tab" aria-controls="till-float-makeup" aria-selected="false">
                            Makeup
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content pt-3" id="tillFloatTabContent">
                    <!-- Till Float Opening Tab -->
                    <div class="tab-pane fade show active" id="till-float-open" role="tabpanel" aria-labelledby="till-float-open-tab">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Denomination</th>
                                    <th>Value ($)</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for denom in denominations %}
                                <tr>
                                    <td>{{ denom }}</td>
                                    <td>
                                        <input type="number" step="0.01" name="till_float_open_{{ denom }}" class="form-control till-float-open-value money-input" 
                                               data-denom="{{ denom }}" min="0" 
                                               value="{{ till_float_open.get(denom, 0) }}" 
                                               {% if takings.settled %}disabled{% endif %}>
                                    </td>
                                    <td class="till-float-open-count" data-denom="{{ denom }}">
                                        {{ denom_counts.till_float_open.get(denom, 0) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="tillfloatOpenTotal">{{ format_currency(till_float_open_total) }}</th>
                                </tr>
                                <tr>
                                    <th colspan="2">Difference from Target ($500.00)</th>
                                    <th id="tillFloatOpenDifference">
                                        {% if till_float_open_total is not none %}
                                            {{ format_currency(till_float_open_total - 500) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Till Float Closing Tab -->
                    <div class="tab-pane fade" id="till-float-close" role="tabpanel" aria-labelledby="till-float-close-tab">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Denomination</th>
                                    <th>Value ($)</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for denom in denominations %}
                                <tr>
                                    <td>{{ denom }}</td>
                                    <td>
                                        <input type="number" step="0.01" name="till_float_close_{{ denom }}" class="form-control till-float-close-value money-input" 
                                               data-denom="{{ denom }}" min="0" 
                                               value="{{ till_float_close.get(denom, 0) }}" 
                                               {% if takings.settled %}disabled{% endif %}>
                                    </td>
                                    <td class="till-float-close-count" data-denom="{{ denom }}">
                                        {{ denom_counts.till_float_close.get(denom, 0) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="tillfloatCloseTotal">{{ format_currency(till_float_close_total) }}</th>
                                </tr>
                                <tr>
                                    <th colspan="2">Difference from Target ($500.00)</th>
                                    <th id="tillFloatCloseDifference">
                                        {% if till_float_close_total is not none %}
                                            {{ format_currency(till_float_close_total - 500) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Till Float Makeup Tab -->
                    <div class="tab-pane fade" id="till-float-makeup" role="tabpanel" aria-labelledby="till-float-makeup-tab">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Denomination</th>
                                    <th>Value ($)</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for denom in denominations %}
                                <tr>
                                    <td>{{ denom }}</td>
                                    <td>
                                        <input type="number" step="0.01" name="till_float_makeup_{{ denom }}" class="form-control till-float-makeup-value money-input" 
                                               data-denom="{{ denom }}" min="0" 
                                               value="{{ till_float_makeup.get(denom, 0) }}" 
                                               {% if takings.settled %}disabled{% endif %}>
                                    </td>
                                    <td class="till-float-makeup-count" data-denom="{{ denom }}">
                                        {{ denom_counts.till_float_makeup.get(denom, 0) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="tillFloatMakeupTotal">{{ format_currency(till_float_makeup_total) }}</th>
                                </tr>
                                <tr>
                                    <th colspan="2">Difference from Target ($500.00)</th>
                                    <th id="tillFloatMakeupDifference">
                                        {% if till_float_makeup_total is not none %}
                                            {{ format_currency(till_float_makeup_total - 500) }}
                                        {% else %}
                                            $0.00
                                        {% endif %}
                                    </th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Daily Trade Variables & Reconciliation -->
        <div class="col-md-6">
            <div class="float-section">
                <h3 class="section-title">Daily Trade Variables</h3>
                
                <div class="form-group">
                    <label for="till_read">Till Read (Total Sales)</label>
                    <input type="number" step="0.01" class="form-control money-input" id="till_read" name="till_read" 
                           value="{{ takings.till_read or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="eftpos_total">EFTPOS Total</label>
                    <input type="number" step="0.01" class="form-control money-input" id="eftpos_total" name="eftpos_total" 
                           value="{{ takings.eftpos_total or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="portable_eftpos_total">Portable EFTPOS Total</label>
                    <input type="number" step="0.01" class="form-control money-input" id="portable_eftpos_total" name="portable_eftpos_total" 
                           value="{{ takings.portable_eftpos_total or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="amex">Amex Total</label>
                    <input type="number" step="0.01" class="form-control money-input" id="amex" name="amex" 
                           value="{{ takings.amex or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="diners">Diners Total</label>
                    <input type="number" step="0.01" class="form-control money-input" id="diners" name="diners" 
                           value="{{ takings.diners or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="account_charges">Account Charges Total</label>
                    <input type="number" step="0.01" class="form-control money-input" id="account_charges" name="account_charges" 
                           value="{{ takings.account_charges or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="total_cash">Total Cash</label>
                    <input type="number" step="0.01" class="form-control money-input" id="total_cash" name="total_cash" 
                           value="{{ takings.total_cash or '' }}" {% if takings.settled %}disabled{% endif %} readonly>
                    <small class="form-text text-muted">This will be calculated automatically from the till reconciliation.</small>
                </div>
                
                <div class="form-group">
                    <label for="points_redeemed">Points Redeemed Total</label>
                    <input type="number" step="0.01" class="form-control money-input" id="points_redeemed" name="points_redeemed" 
                           value="{{ takings.points_redeemed or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
                
                <div class="form-group">
                    <label for="customer_count">Customer Count</label>
                    <input type="number" class="form-control" id="customer_count" name="customer_count" 
                           value="{{ takings.customer_count or '' }}" {% if takings.settled %}disabled{% endif %}>
                </div>
            </div>
            
            <div class="float-section">
                <h3 class="section-title">End of Trade Reconciliation</h3>
                
                <div class="totals-box">
                    <h4>Summary</h4>
                    <table class="table table-sm">
                        <tr>
                            <td>Till Read:</td>
                            <td class="text-end" id="reconciliation_till_read">{{ format_currency(takings.till_read) }}</td>
                        </tr>
                        <tr>
                            <td>EFTPOS:</td>
                            <td class="text-end" id="reconciliation_eftpos">{{ format_currency(takings.eftpos_total) }}</td>
                        </tr>
                        <tr>
                            <td>Portable EFTPOS:</td>
                            <td class="text-end" id="reconciliation_portable_eftpos">{{ format_currency(takings.portable_eftpos_total) }}</td>
                        </tr>
                        <tr>
                            <td>Amex:</td>
                            <td class="text-end" id="reconciliation_amex">{{ format_currency(takings.amex) }}</td>
                        </tr>
                        <tr>
                            <td>Diners:</td>
                            <td class="text-end" id="reconciliation_diners">{{ format_currency(takings.diners) }}</td>
                        </tr>
                        <tr>
                            <td>Account Charges:</td>
                            <td class="text-end" id="reconciliation_account_charges">{{ format_currency(takings.account_charges) }}</td>
                        </tr>
                        <tr>
                            <td>Cash:</td>
                            <td class="text-end" id="reconciliation_cash">{{ format_currency(takings.total_cash) }}</td>
                        </tr>
                        <tr class="table-active">
                            <th>Total Payment Methods:</th>
                            <td class="text-end" id="reconciliation_payment_total">
                                {% set payment_total = (takings.eftpos_total or 0) + (takings.portable_eftpos_total or 0) + 
                                                      (takings.amex or 0) + (takings.diners or 0) + 
                                                      (takings.account_charges or 0) + (takings.total_cash or 0) %}
                                {{ format_currency(payment_total) }}
                            </td>
                        </tr>
                        <tr class="table-active">
                            <th>Variance:</th>
                            <td class="text-end {% if takings.variance is not none and takings.variance > 0 %}variance-positive{% elif takings.variance is not none and takings.variance < 0 %}variance-negative{% endif %}" id="reconciliation_variance">
                                {{ format_currency(takings.variance) }}
                            </td>
                        </tr>
                    </table>
                </div>
                
                {% if not takings.settled %}
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="submit" name="settle" value="true" class="btn btn-success">Save & Settle</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</form>

<!-- Denomination Entry Modal -->
<div class="modal fade" id="denominationEntryModal" tabindex="-1" aria-labelledby="denominationEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="denominationEntryModalLabel">Count Denomination</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="denominationEntryForm">
                    <div class="mb-3">
                        <label id="denominationLabel" class="form-label">Enter value of <span id="currentDenomination"></span> in the till:</label>
                        <input type="number" class="form-control" id="denominationValue" step="0.01" min="0" required>
                        <small id="denominationHint" class="form-text text-muted">Maximum value for till float: <span id="maxDenominationValue"></span></small>
                    </div>
                    <div id="denominationMessage" class="alert alert-info d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="nextDenomination">Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Modal -->
<div class="modal fade" id="tillCountSummaryModal" tabindex="-1" aria-labelledby="tillCountSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tillCountSummaryModalLabel">Till Count Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Till Float ($500.00)</h6>
                        <table class="table table-sm" id="tillFloatSummaryTable">
                            <thead>
                                <tr>
                                    <th>Denomination</th>
                                    <th>Value</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="2">Total</th>
                                    <th id="tillFloatSummaryTotal">$0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Cash Takings</h6>
                        <table class="table table-sm" id="cashTakingsSummaryTable">
                            <thead>
                                <tr>
                                    <th>Denomination</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                            <tfoot>
                                <tr>
                                    <th>Total</th>
                                    <th id="cashTakingsSummaryTotal">$0.00</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="applyTillCount">Apply</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Define all denominations and their values
        const denominations = {};
        {% for denom in denominations %}
        denominations["{{ denom }}"] = {{ denom_values[denom] }};
        {% endfor %}
        
        // Define denomination upper limits for till float
        const denominationLimits = {
            "5c": 4.00,
            "10c": 8.00,
            "20c": 8.00,
            "50c": 20.00,
            "$1": 50.00,
            "$2": 100.00,
            "$5": 200.00,
            "$10": 200.00,
            "$20": 200.00,
            "$50": 200.00,
            "$100": 0.00
        };
        
        // Define ordered denomination list for processing
        const denominationOrder = ['5c', '10c', '20c', '50c', '$1', '$2', '$5', '$10', '$20', '$50', '$100'];
        
        // Variables to track counting process
        let currentDenominationIndex = 0;
        let remainingTillTarget = 500.00;
        let countedDenominations = {};
        let tillFloatValues = {};
        let cashTakingsValues = {};
        
        // Check if we should run the test
        if (window.location.search.includes('test_till_algorithm=true')) {
            runAlgorithmTest();
        }
        
        // Test function to verify the algorithm
        function runAlgorithmTest() {
            console.log("Running Till Float Algorithm Test");
            
            // Set up test data - similar to user's example
            countedDenominations = {
                '5c': 2.35,      // 47 coins
                '10c': 4.80,     // 48 coins
                '20c': 5.40,     // 27 coins
                '50c': 11.50,    // 23 coins
                '$1': 48.00,     // 48 coins
                '$2': 52.00,     // 26 coins
                '$5': 115.00,    // 23 notes
                '$10': 230.00,   // 23 notes
                '$20': 360.00,   // 18 notes
                '$50': 1050.00,  // 21 notes
                '$100': 200.00   // 2 notes
            };
            
            // Run the algorithm
            finalizeTillFloat();
            
            // Display results
            console.log("--- TILL FLOAT ALGORITHM TEST RESULTS ---");
            console.log("Original Counts:", countedDenominations);
            
            // Calculate total coin value in till float
            let coinTotal = 0;
            for (const denom of ['5c', '10c', '20c', '50c']) {
                coinTotal += tillFloatValues[denom];
            }
            
            // Calculate total note value in till float
            let noteTotal = 0;
            for (const denom of ['$1', '$2', '$5', '$10', '$20', '$50', '$100']) {
                noteTotal += tillFloatValues[denom];
            }
            
            // Calculate overall totals
            let tillTotal = 0;
            let cashTotal = 0;
            for (const denom of denominationOrder) {
                tillTotal += tillFloatValues[denom];
                cashTotal += cashTakingsValues[denom];
            }
            
            // Verify coin total is rounded to nearest $5
            const roundedCoinTotal = Math.floor(coinTotal / 5) * 5;
            
            console.log("\nTILL FLOAT:");
            for (const denom of denominationOrder) {
                if (tillFloatValues[denom] > 0) {
                    const count = Math.round(tillFloatValues[denom] / denominations[denom]);
                    console.log(`${denom}: $${tillFloatValues[denom].toFixed(2)} (${count} units)`);
                }
            }
            console.log(`Coin Total: $${coinTotal.toFixed(2)} (Rounded: $${roundedCoinTotal.toFixed(2)})`);
            console.log(`Note Total: $${noteTotal.toFixed(2)}`);
            console.log(`OVERALL TILL TOTAL: $${tillTotal.toFixed(2)}`);
            
            console.log("\nCASH TAKINGS:");
            for (const denom of denominationOrder) {
                if (cashTakingsValues[denom] > 0) {
                    const count = Math.round(cashTakingsValues[denom] / denominations[denom]);
                    console.log(`${denom}: $${cashTakingsValues[denom].toFixed(2)} (${count} units)`);
                }
            }
            console.log(`OVERALL CASH TAKINGS TOTAL: $${cashTotal.toFixed(2)}`);
            
            // Verify the results
            const isExactly500 = tillTotal === 500;
            const isCoinTotalRounded = coinTotal === roundedCoinTotal;
            
            console.log("\nVERIFICATION:");
            console.log(`Till total is exactly $500.00: ${isExactly500 ? 'PASS ✓' : 'FAIL ✗'}`);
            console.log(`Coin total is rounded to nearest $5: ${isCoinTotalRounded ? 'PASS ✓' : 'FAIL ✗'}`);
            console.log(`Combined total matches original: ${(tillTotal + cashTotal === Object.values(countedDenominations).reduce((a, b) => a + b, 0)) ? 'PASS ✓' : 'FAIL ✗'}`);
            
            // Create alert with summary
            let alertMessage = "Till Float Algorithm Test Results:\n";
            alertMessage += `Till Total: $${tillTotal.toFixed(2)}\n`;
            alertMessage += `Cash Takings Total: $${cashTotal.toFixed(2)}\n\n`;
            alertMessage += `Verification:\n`;
            alertMessage += `Till total is exactly $500.00: ${isExactly500 ? 'PASS ✓' : 'FAIL ✗'}\n`;
            alertMessage += `Coin total is rounded to nearest $5: ${isCoinTotalRounded ? 'PASS ✓' : 'FAIL ✗'}\n`;
            alertMessage += "See console for detailed breakdown.";
            
            alert(alertMessage);
        }
        
        // Initialize all denomination displays
        function updateAllDenominationDisplays() {
            updateDenominationDisplays('safe-float-open');
            updateDenominationDisplays('safe-float-close');
            updateDenominationDisplays('till-float-open');
            updateDenominationDisplays('till-float-close');
            updateDenominationDisplays('till-float-makeup');
            updateReconciliationSummary();
            formatAllInputValues();
        }
        
        // Count Till functionality
        document.getElementById('countTillButton').addEventListener('click', startTillCount);
        document.getElementById('nextDenomination').addEventListener('click', processCurrentDenomination);
        document.getElementById('applyTillCount').addEventListener('click', applyTillCount);
        
        // Handle Enter key in denomination input
        document.getElementById('denominationValue').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                processCurrentDenomination();
            }
        });
        
        // Start the till count process
        function startTillCount() {
            // Reset variables
            currentDenominationIndex = 0;
            remainingTillTarget = 500.00;
            countedDenominations = {};
            tillFloatValues = {};
            cashTakingsValues = {};
            
            // Start with the first denomination
            showDenominationEntry(denominationOrder[currentDenominationIndex]);
        }
        
        // Show denomination entry modal
        function showDenominationEntry(denom) {
            // Set current denomination in modal
            document.getElementById('currentDenomination').textContent = denom;
            document.getElementById('maxDenominationValue').textContent = '$' + denominationLimits[denom].toFixed(2);
            document.getElementById('denominationValue').value = '';
            document.getElementById('denominationMessage').classList.add('d-none');
            
            // Show modal
            const denominationModal = new bootstrap.Modal(document.getElementById('denominationEntryModal'));
            denominationModal.show();
            
            // Focus on input field
            setTimeout(function() {
                document.getElementById('denominationValue').focus();
            }, 500);
        }
        
        // Process entered denomination value
        function processCurrentDenomination() {
            const currentDenom = denominationOrder[currentDenominationIndex];
            const enteredValue = parseFloat(document.getElementById('denominationValue').value) || 0;
            const denomValue = denominations[currentDenom];
            
            // Calculate counts and values
            const totalCount = Math.floor(enteredValue / denomValue);
            const totalValue = totalCount * denomValue;
            
            // Store the total value entered
            countedDenominations[currentDenom] = enteredValue;
            
            // Calculate till float value for this denomination (respect limit)
            let tillFloatValue = Math.min(enteredValue, denominationLimits[currentDenom]);
            
            // Adjust to full denomination units
            const tillFloatCount = Math.floor(tillFloatValue / denomValue);
            tillFloatValue = tillFloatCount * denomValue;
            
            // Check if we need to further limit based on remaining target
            if (tillFloatValue > remainingTillTarget) {
                // Calculate how many units we can take
                const allowedCount = Math.floor(remainingTillTarget / denomValue);
                tillFloatValue = allowedCount * denomValue;
            }
            
            // Store values
            tillFloatValues[currentDenom] = tillFloatValue;
            cashTakingsValues[currentDenom] = enteredValue - tillFloatValue;
            
            // Update remaining target
            remainingTillTarget -= tillFloatValue;
            
            // Show message if there's excess
            if (enteredValue > tillFloatValue) {
                const excessValue = enteredValue - tillFloatValue;
                const excessCount = Math.ceil(excessValue / denomValue);
                const message = `Added $${tillFloatValue.toFixed(2)} to till float. ${excessCount} ${currentDenom} (${formatCurrency(excessValue)}) will be added to cash takings.`;
                
                document.getElementById('denominationMessage').textContent = message;
                document.getElementById('denominationMessage').classList.remove('d-none');
                document.getElementById('denominationMessage').classList.remove('alert-danger');
                document.getElementById('denominationMessage').classList.add('alert-info');
                
                // Give user time to read the message
                setTimeout(function() {
                    moveToNextDenomination();
                }, 2000);
            } else {
                moveToNextDenomination();
            }
        }
        
        // Move to next denomination or show summary
        function moveToNextDenomination() {
            currentDenominationIndex++;
            
            // Check if we've completed all denominations or reached target
            if (currentDenominationIndex >= denominationOrder.length || remainingTillTarget <= 0) {
                // If we haven't reached $500 for till float and there are more denominations, 
                // continue to next denomination
                if (remainingTillTarget > 0 && currentDenominationIndex < denominationOrder.length) {
                    showDenominationEntry(denominationOrder[currentDenominationIndex]);
                } else {
                    // Show summary
                    showTillCountSummary();
                }
            } else {
                // Move to next denomination
                showDenominationEntry(denominationOrder[currentDenominationIndex]);
            }
        }
        
        // Show till count summary
        function showTillCountSummary() {
            // Hide denomination entry modal
            const denominationModal = bootstrap.Modal.getInstance(document.getElementById('denominationEntryModal'));
            denominationModal.hide();
            
            // Recalculate till float to ensure it's exactly $500
            finalizeTillFloat();
            
            // Build summary tables
            const tillFloatBody = document.querySelector('#tillFloatSummaryTable tbody');
            const cashTakingsBody = document.querySelector('#cashTakingsSummaryTable tbody');
            
            // Clear tables
            tillFloatBody.innerHTML = '';
            cashTakingsBody.innerHTML = '';
            
            let tillFloatTotal = 0;
            let cashTakingsTotal = 0;
            
            // Add rows for each denomination
            for (const denom of denominationOrder) {
                const denomValue = denominations[denom];
                
                // Till Float row
                if (tillFloatValues[denom] && tillFloatValues[denom] > 0) {
                    const tillFloatCount = Math.round(tillFloatValues[denom] / denomValue);
                    tillFloatTotal += tillFloatValues[denom];
                    
                    const tillRow = document.createElement('tr');
                    tillRow.innerHTML = `
                        <td>${denom}</td>
                        <td>${formatCurrency(tillFloatValues[denom])}</td>
                        <td>${tillFloatCount}</td>
                    `;
                    tillFloatBody.appendChild(tillRow);
                }
                
                // Cash Takings row
                if (cashTakingsValues[denom] && cashTakingsValues[denom] > 0) {
                    cashTakingsTotal += cashTakingsValues[denom];
                    
                    const cashRow = document.createElement('tr');
                    cashRow.innerHTML = `
                        <td>${denom}</td>
                        <td>${formatCurrency(cashTakingsValues[denom])}</td>
                    `;
                    cashTakingsBody.appendChild(cashRow);
                }
            }
            
            // Update totals
            document.getElementById('tillFloatSummaryTotal').textContent = formatCurrency(tillFloatTotal);
            document.getElementById('cashTakingsSummaryTotal').textContent = formatCurrency(cashTakingsTotal);
            
            // Show summary modal
            const summaryModal = new bootstrap.Modal(document.getElementById('tillCountSummaryModal'));
            summaryModal.show();
        }
        
        // Finalize till float calculation to ensure it's exactly $500
        function finalizeTillFloat() {
            // Separate coins and notes
            const coinDenoms = ['5c', '10c', '20c', '50c'];
            const noteDenoms = ['$1', '$2', '$5', '$10', '$20', '$50', '$100'];
            
            // Store original counted values
            let originalCounted = {...countedDenominations};
            
            // Reset the till float and cash takings values
            tillFloatValues = {};
            cashTakingsValues = {};
            
            // STEP 1: First collect all available coins (up to limits)
            let totalAvailableCoins = {};
            for (const denom of coinDenoms) {
                const available = originalCounted[denom] || 0;
                const denomValue = denominations[denom];
                
                // Get whole units
                const units = Math.floor(available / denomValue);
                const wholeValue = units * denomValue;
                
                // This is how much we have available in whole units
                totalAvailableCoins[denom] = wholeValue;
                
                // Initialize cash takings for any fractional parts
                cashTakingsValues[denom] = available - wholeValue;
            }
            
            // STEP 2: Calculate total coin value and round down to nearest $5
            let totalCoinValue = Object.values(totalAvailableCoins).reduce((sum, val) => sum + val, 0);
            const roundedCoinValue = Math.floor(totalCoinValue / 5) * 5;
            
            // STEP 3: Determine which coins to keep in till float to match rounded value
            // Start by taking as many coins as possible (up to limit)
            for (const denom of coinDenoms) {
                const denomValue = denominations[denom];
                const available = totalAvailableCoins[denom];
                const limit = denominationLimits[denom];
                
                // Take the minimum of available coins and limit
                tillFloatValues[denom] = Math.min(available, limit);
                
                // Any excess goes to cash takings
                cashTakingsValues[denom] += (available - tillFloatValues[denom]);
            }
            
            // Calculate actual coin total
            let actualCoinTotal = 0;
            for (const denom of coinDenoms) {
                actualCoinTotal += tillFloatValues[denom];
            }
            
            // If we're over the rounded value, remove excess coins
            if (actualCoinTotal > roundedCoinValue) {
                let excess = actualCoinTotal - roundedCoinValue;
                
                // Remove excess coins starting from largest denominations
                for (let i = coinDenoms.length - 1; i >= 0; i--) {
                    const denom = coinDenoms[i];
                    const denomValue = denominations[denom];
                    
                    if (excess > 0 && tillFloatValues[denom] > 0) {
                        // How many units we can remove
                        const unitsToRemove = Math.min(
                            Math.ceil(excess / denomValue),
                            Math.floor(tillFloatValues[denom] / denomValue)
                        );
                        
                        // Value to remove
                        const valueToRemove = unitsToRemove * denomValue;
                        
                        // Update values
                        tillFloatValues[denom] -= valueToRemove;
                        cashTakingsValues[denom] += valueToRemove;
                        excess -= valueToRemove;
                        
                        if (excess <= 0) break;
                    }
                }
            }
            
            // Recalculate coin total after adjustments
            actualCoinTotal = 0;
            for (const denom of coinDenoms) {
                actualCoinTotal += tillFloatValues[denom];
            }
            
            // STEP 4: Now we need notes to reach $500 total
            const notesNeeded = 500 - actualCoinTotal;
            
            // STEP 5: Add notes starting from smallest denominations
            let remainingNoteTarget = notesNeeded;
            for (const denom of noteDenoms) {
                // Skip if we've reached our target
                if (remainingNoteTarget <= 0) break;
                
                const available = originalCounted[denom] || 0;
                const denomValue = denominations[denom];
                
                // Skip $100 notes if limit is 0
                if (denom === '$100' && denominationLimits[denom] === 0) {
                    cashTakingsValues[denom] = available;
                    continue;
                }
                
                // How many units we need and can take (respecting limits)
                const unitsNeeded = Math.floor(remainingNoteTarget / denomValue);
                const unitsAvailable = Math.floor(available / denomValue);
                const unitsWithinLimit = Math.floor(denominationLimits[denom] / denomValue);
                const unitsToTake = Math.min(unitsNeeded, unitsAvailable, unitsWithinLimit);
                
                // Value for till float
                const valueForTill = unitsToTake * denomValue;
                
                // Add to till float
                tillFloatValues[denom] = valueForTill;
                
                // Rest goes to cash takings
                cashTakingsValues[denom] = available - valueForTill;
                
                // Update remaining target
                remainingNoteTarget -= valueForTill;
            }
            
            // STEP 6: Final check - if we couldn't reach $500 exactly with available coins/notes,
            // we need to make adjustments
            let tillTotal = 0;
            for (const denom of [...coinDenoms, ...noteDenoms]) {
                tillTotal += (tillFloatValues[denom] || 0);
            }
            
            // If we're not exactly at $500, make final adjustments
            if (tillTotal !== 500) {
                const difference = 500 - tillTotal;
                
                if (difference > 0) {
                    // Need to add more to till float from cash takings
                    // Try with smallest denominations first
                    for (const denom of noteDenoms) {
                        const denomValue = denominations[denom];
                        const cashAmount = cashTakingsValues[denom] || 0;
                        
                        if (cashAmount >= denomValue && denomValue <= difference) {
                            // Units we need and can take
                            const unitsNeeded = Math.ceil(difference / denomValue);
                            const unitsAvailable = Math.floor(cashAmount / denomValue);
                            const unitsToMove = Math.min(unitsNeeded, unitsAvailable, 1); // Start with just 1 unit
                            
                            // Value to move
                            const valueToMove = unitsToMove * denomValue;
                            
                            // Move from cash to till
                            tillFloatValues[denom] = (tillFloatValues[denom] || 0) + valueToMove;
                            cashTakingsValues[denom] -= valueToMove;
                            
                            // Check if we've reached $500
                            tillTotal += valueToMove;
                            if (tillTotal >= 500) break;
                        }
                    }
                } else {
                    // Need to remove from till float to cash takings
                    // Start with largest denominations
                    for (let i = noteDenoms.length - 1; i >= 0; i--) {
                        const denom = noteDenoms[i];
                        const denomValue = denominations[denom];
                        const tillAmount = tillFloatValues[denom] || 0;
                        
                        if (tillAmount >= denomValue) {
                            // Units needed and available
                            const unitsToMove = 1; // Start with just 1 unit
                            
                            // Value to move
                            const valueToMove = unitsToMove * denomValue;
                            
                            // Move from till to cash
                            tillFloatValues[denom] -= valueToMove;
                            cashTakingsValues[denom] = (cashTakingsValues[denom] || 0) + valueToMove;
                            
                            // Check if we've reached $500
                            tillTotal -= valueToMove;
                            if (tillTotal <= 500) break;
                        }
                    }
                }
            }
            
            // STEP 7: Force to $500 if still not exact
            tillTotal = 0;
            for (const denom of [...coinDenoms, ...noteDenoms]) {
                tillTotal += (tillFloatValues[denom] || 0);
            }
            
            if (tillTotal !== 500) {
                // Find any note to adjust
                if (tillTotal < 500) {
                    for (const denom of noteDenoms) {
                        if (cashTakingsValues[denom] > 0) {
                            // Move exactly what we need
                            const needed = 500 - tillTotal;
                            const denomValue = denominations[denom];
                            const unitsToMove = Math.ceil(needed / denomValue);
                            const valueToMove = unitsToMove * denomValue;
                            
                            tillFloatValues[denom] = (tillFloatValues[denom] || 0) + valueToMove;
                            cashTakingsValues[denom] -= valueToMove;
                            break;
                        }
                    }
                } else {
                    for (let i = noteDenoms.length - 1; i >= 0; i--) {
                        const denom = noteDenoms[i];
                        if (tillFloatValues[denom] > 0) {
                            // Move exactly what we need
                            const excess = tillTotal - 500;
                            const denomValue = denominations[denom];
                            const unitsToMove = Math.ceil(excess / denomValue);
                            const valueToMove = unitsToMove * denomValue;
                            
                            tillFloatValues[denom] -= valueToMove;
                            cashTakingsValues[denom] = (cashTakingsValues[denom] || 0) + valueToMove;
                            break;
                        }
                    }
                }
            }
            
            // Ensure all denominations are initialized with at least 0
            for (const denom of denominationOrder) {
                tillFloatValues[denom] = tillFloatValues[denom] || 0;
                cashTakingsValues[denom] = cashTakingsValues[denom] || 0;
            }
            
            // Compute final totals one more time for safety
            let finalTillTotal = 0;
            let finalCoinTotal = 0;
            
            for (const denom of coinDenoms) {
                finalCoinTotal += tillFloatValues[denom];
            }
            
            for (const denom of [...coinDenoms, ...noteDenoms]) {
                finalTillTotal += tillFloatValues[denom];
            }
            
            // Force round coin total if needed
            if (Math.floor(finalCoinTotal / 5) * 5 !== finalCoinTotal) {
                console.error("Warning: Coin total is not rounded to nearest $5");
            }
            
            // Force till total if needed
            if (finalTillTotal !== 500) {
                console.error("Warning: Till total is not exactly $500");
                
                // Emergency adjustment - find a note to adjust
                const diff = 500 - finalTillTotal;
                for (const denom of noteDenoms) {
                    const denomValue = denominations[denom];
                    if (diff > 0 && cashTakingsValues[denom] >= denomValue) {
                        // Need to add a note to till
                        tillFloatValues[denom] += denomValue;
                        cashTakingsValues[denom] -= denomValue;
                        break;
                    } else if (diff < 0 && tillFloatValues[denom] >= denomValue) {
                        // Need to remove a note from till
                        tillFloatValues[denom] -= denomValue;
                        cashTakingsValues[denom] = (cashTakingsValues[denom] || 0) + denomValue;
                        break;
                    }
                }
            }
        }
        
        // Apply the till count results to the form
        function applyTillCount() {
            // Apply values to till float close inputs
            for (const denom of denominationOrder) {
                const tillInput = document.querySelector(`.till-float-close-value[data-denom="${denom}"]`);
                if (tillInput) {
                    const value = tillFloatValues[denom] || 0;
                    tillInput.value = value.toFixed(2);
                }
            }
            
            // Update the total cash field
            const totalCashInput = document.getElementById('total_cash');
            const cashTakingsTotal = Object.values(cashTakingsValues).reduce((sum, value) => sum + value, 0);
            if (totalCashInput) {
                totalCashInput.value = cashTakingsTotal.toFixed(2);
            }
            
            // Hide summary modal
            const summaryModal = bootstrap.Modal.getInstance(document.getElementById('tillCountSummaryModal'));
            summaryModal.hide();
            
            // Update the display
            updateDenominationDisplays('till-float-close');
            
            // Automatically switch to till float makeup tab
            setTimeout(function() {
                const tillFloatMakeupTab = document.getElementById('till-float-makeup-tab');
                if (tillFloatMakeupTab) {
                    tillFloatMakeupTab.click();
                }
            }, 500);
            
            // Auto-calculate till float makeup
            autoCalculateTillFloatMakeup();
        }
        
        // Auto-calculate till float makeup based on close values
        function autoCalculateTillFloatMakeup() {
            const makeupInputs = document.querySelectorAll('.till-float-makeup-value');
            
            // Clear all values first
            makeupInputs.forEach(input => {
                input.value = "0.00";
            });
            
            let remainingTarget = 500.00;
            
            // Process denominations from smallest to largest for the makeup
            for (const denom of denominationOrder) {
                if (remainingTarget <= 0) break;
                
                // Skip $100 notes (limit is 0)
                if (denom === '$100') continue;
                
                // Find the close input and makeup input for this denomination
                const closeInput = document.querySelector(`.till-float-close-value[data-denom="${denom}"]`);
                const makeupInput = document.querySelector(`.till-float-makeup-value[data-denom="${denom}"]`);
                
                if (closeInput && makeupInput) {
                    const closeValue = parseFloat(closeInput.value) || 0;
                    const denomValue = denominations[denom];
                    
                    // How much of this denomination should go to the makeup?
                    let makeupValue = Math.min(closeValue, remainingTarget);
                    
                    // Adjust to ensure we use full coins/notes
                    makeupValue = Math.floor(makeupValue / denomValue) * denomValue;
                    
                    if (makeupValue > 0) {
                        makeupInput.value = makeupValue.toFixed(2);
                        remainingTarget -= makeupValue;
                    }
                }
            }
            
            // Update the display
            updateDenominationDisplays('till-float-makeup');
        }
        
        // Update values and counts for a specific denomination section
        function updateDenominationDisplays(section) {
            const valueInputs = document.querySelectorAll(`.${section}-value`);
            let total = 0;
            
            valueInputs.forEach(input => {
                const denom = input.dataset.denom;
                const value = parseFloat(input.value) || 0;
                const countDisplay = document.querySelector(`.${section}-count[data-denom="${denom}"]`);
                
                // Calculate count from value
                const denomValue = denominations[denom];
                const count = Math.round(value / denomValue);
                
                if (countDisplay) {
                    countDisplay.textContent = count;
                }
                
                total += value;
            });
            
            // Update the total for this section
            const sectionId = section.replace(/-/g, '');
            const totalElement = document.getElementById(`${sectionId}Total`);
            if (totalElement) {
                totalElement.textContent = formatCurrency(total);
            }
            
            // Update difference from target
            const differenceElement = document.getElementById(`${section.replace(/-/g, '')}Difference`);
            if (differenceElement) {
                const targetValue = section.includes('safe') ? 1500 : 500;
                const difference = total - targetValue;
                differenceElement.textContent = formatCurrency(difference);
                
                // Add color coding for difference
                if (difference > 0) {
                    differenceElement.classList.add('variance-positive');
                    differenceElement.classList.remove('variance-negative');
                } else if (difference < 0) {
                    differenceElement.classList.add('variance-negative');
                    differenceElement.classList.remove('variance-positive');
                } else {
                    differenceElement.classList.remove('variance-positive', 'variance-negative');
                }
            }
            
            // If this is the till float close, auto-calculate till float and cash takings
            if (section === 'till-float-close') {
                autoCalculateTillFloatAndCashTakings(total);
            }
        }
        
        // Auto-calculate till float (maintain $500) and set excess as cash takings total
        function autoCalculateTillFloatAndCashTakings(tillTotal) {
            const TARGET_TILL_FLOAT = 500.00;
            const totalCashField = document.getElementById('total_cash');
            
            // If till total is less than target, we can't make up the float
            if (tillTotal < TARGET_TILL_FLOAT) {
                if (totalCashField) {
                    totalCashField.value = "0.00";
                }
                return;
            }
            
            // Calculate excess to be used as cash takings
            const cashTakings = tillTotal - TARGET_TILL_FLOAT;
            
            // Update cash takings field
            if (totalCashField) {
                totalCashField.value = cashTakings.toFixed(2);
            }
            
            // Trigger reconciliation summary update
            updateReconciliationSummary();
            
            // Auto-distribute denominations for till float makeup if needed
            // This would typically call the API but we'll handle a basic version here
            autoDistributeTillFloatMakeup(cashTakings);
        }
        
        // Auto-distribute denominations for till float makeup (simplified version)
        function autoDistributeTillFloatMakeup(excessValue) {
            // Only auto-populate if excess exists and till float makeup tab is empty
            if (excessValue <= 0) return;
            
            // Check if till float makeup is currently empty
            const makeupInputs = document.querySelectorAll('.till-float-makeup-value');
            let currentMakeupTotal = 0;
            makeupInputs.forEach(input => {
                currentMakeupTotal += parseFloat(input.value) || 0;
            });
            
            // Only auto-populate if makeup is empty (to avoid overwriting user entries)
            if (currentMakeupTotal === 0) {
                // This is a simplified version that just sets the makeup to $500
                // In a real implementation, you would call the calculate-optimal-float API
                
                // Clear all values first
                makeupInputs.forEach(input => {
                    input.value = "0.00";
                });
                
                // Get the till float close values to copy
                const closeInputs = document.querySelectorAll('.till-float-close-value');
                let remainingTarget = 500.00;
                
                // Process denominations from smallest to largest for the makeup
                // This simplifies distribution but isn't as sophisticated as the API
                const denomOrder = ['5c', '10c', '20c', '50c', '$1', '$2', '$5', '$10', '$20', '$50', '$100'];
                
                for (const denom of denomOrder) {
                    if (remainingTarget <= 0) break;
                    
                    // Find the close input and makeup input for this denomination
                    const closeInput = Array.from(closeInputs).find(input => input.dataset.denom === denom);
                    const makeupInput = Array.from(makeupInputs).find(input => input.dataset.denom === denom);
                    
                    if (closeInput && makeupInput) {
                        const closeValue = parseFloat(closeInput.value) || 0;
                        const denomValue = denominations[denom];
                        
                        // How much of this denomination should go to the makeup?
                        let makeupValue = Math.min(closeValue, remainingTarget);
                        
                        // Adjust to ensure we use full coins/notes
                        makeupValue = Math.floor(makeupValue / denomValue) * denomValue;
                        
                        if (makeupValue > 0) {
                            makeupInput.value = makeupValue.toFixed(2);
                            remainingTarget -= makeupValue;
                        }
                    }
                }
                
                // Update the makeup display
                updateDenominationDisplays('till-float-makeup');
            }
        }
        
        // Update reconciliation summary
        function updateReconciliationSummary() {
            // Get values from form fields
            const tillRead = parseFloat(document.getElementById('till_read').value) || 0;
            const eftposTotal = parseFloat(document.getElementById('eftpos_total').value) || 0;
            const portableEftposTotal = parseFloat(document.getElementById('portable_eftpos_total').value) || 0;
            const amex = parseFloat(document.getElementById('amex').value) || 0;
            const diners = parseFloat(document.getElementById('diners').value) || 0;
            const accountCharges = parseFloat(document.getElementById('account_charges').value) || 0;
            const totalCash = parseFloat(document.getElementById('total_cash').value) || 0;
            
            // Update display elements
            document.getElementById('reconciliation_till_read').textContent = formatCurrency(tillRead);
            document.getElementById('reconciliation_eftpos').textContent = formatCurrency(eftposTotal);
            document.getElementById('reconciliation_portable_eftpos').textContent = formatCurrency(portableEftposTotal);
            document.getElementById('reconciliation_amex').textContent = formatCurrency(amex);
            document.getElementById('reconciliation_diners').textContent = formatCurrency(diners);
            document.getElementById('reconciliation_account_charges').textContent = formatCurrency(accountCharges);
            document.getElementById('reconciliation_cash').textContent = formatCurrency(totalCash);
            
            // Calculate payment total
            const paymentTotal = eftposTotal + portableEftposTotal + amex + diners + accountCharges + totalCash;
            document.getElementById('reconciliation_payment_total').textContent = formatCurrency(paymentTotal);
            
            // Calculate variance
            const variance = tillRead - paymentTotal;
            const varianceElement = document.getElementById('reconciliation_variance');
            varianceElement.textContent = formatCurrency(variance);
            
            // Add color coding for variance
            if (variance > 0) {
                varianceElement.classList.add('variance-positive');
                varianceElement.classList.remove('variance-negative');
            } else if (variance < 0) {
                varianceElement.classList.add('variance-negative');
                varianceElement.classList.remove('variance-positive');
            } else {
                varianceElement.classList.remove('variance-positive', 'variance-negative');
            }
        }
        
        // Format currency for display
        function formatCurrency(value) {
            return '$' + (parseFloat(value) || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Format all input values to $xx.xx format
        function formatAllInputValues() {
            document.querySelectorAll('.money-input').forEach(input => {
                if (input.value === '') {
                    input.value = '0.00';
                } else {
                    // Format to two decimal places
                    input.value = (parseFloat(input.value) || 0).toFixed(2);
                }
            });
        }
        
        // Handle focus events on money inputs
        document.querySelectorAll('.money-input').forEach(input => {
            // Select all text when focused
            input.addEventListener('focus', function() {
                this.select();
                // Add highlight to parent cell
                const parentCell = this.closest('td');
                if (parentCell) {
                    parentCell.classList.add('field-focused');
                }
            });
            
            // Remove highlight when focus is lost
            input.addEventListener('blur', function() {
                const parentCell = this.closest('td');
                if (parentCell) {
                    parentCell.classList.remove('field-focused');
                }
                
                // Format the value
                if (this.value === '') {
                    this.value = '0.00';
                } else {
                    this.value = (parseFloat(this.value) || 0).toFixed(2);
                }
                
                // If this is in till-float-close, recalculate cash takings
                if (this.classList.contains('till-float-close-value')) {
                    updateDenominationDisplays('till-float-close');
                }
            });
        });
        
        // Add event listeners for value inputs with real-time updates
        document.querySelectorAll('.safe-float-open-value, .safe-float-close-value, .till-float-open-value, .till-float-close-value, .till-float-makeup-value').forEach(input => {
            input.addEventListener('input', function() {
                const section = this.classList[1].replace('-value', '');
                updateDenominationDisplays(section);
                
                // For till-float-close section, calculate cash takings immediately
                if (section === 'till-float-close') {
                    const totalCashField = document.getElementById('total_cash');
                    if (totalCashField && !totalCashField.hasAttribute('disabled')) {
                        updateReconciliationSummary();
                    }
                }
            });
        });
        
        // Add event listeners for trade variables
        document.querySelectorAll('#till_read, #eftpos_total, #portable_eftpos_total, #amex, #diners, #account_charges').forEach(input => {
            input.addEventListener('input', updateReconciliationSummary);
        });
        
        // Special handling for tabs to update calculations when switching
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function() {
                updateAllDenominationDisplays();
            });
        });
        
        // Initialize the display on page load
        updateAllDenominationDisplays();
    });
</script>
{% endblock %} 